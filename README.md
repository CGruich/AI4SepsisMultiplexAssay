Files in this folder:

- all files used and generated by the algorithm are in `data` (at least for now)

  - `data/models` contains the best region detector and code classifier 

  - `data/raw` contains raw images

  - `data/classifier_training_samples` contains classified particles


How to name files:

- The directory name should start like so: `code (1)`, `code (2)`, etc. Each corresponding code for the color images of barcodes should be `code (1) color`, `code (2) color`, etc.

- name each ref image in each directory: `1_ref.tiff`, `2_ref.tiff`, etc

- name each corresponding particle image: name the first image corresponding to `1_ref.tiff` as `1.tiff`, and subsequent ones `1_2.tiff`, `1_3.tiff`, etc. if there are multiple images corresponding to one reference image.

How to run the codebase:

0. Activate virtual environment. We use `mamba` to install the Anaconda virtual environment, which we can then activate to do work on the experiment, e.g., `conda activate venv_cg_gpu`


To use this codebase, run main.py. Depending on your task, do the following. 

1. If you don't have MSER parameters, in terminal or Jupyter notebook, do `python main.py --action find_mser_params`. 

2. Train the region detector as follows. 

- Choose a directory containing raw images as the training and validation dataset. Do `python main.py --action classify_regions --dir your_raw_image_folder`, and replace `your_raw_image_folder` with your directory. Cropped particles are in `data/classifier_training_samples`. Alternatively, run `train_region_classifier.ipynb` under the same directions.

- In `data/classifier_training_samples`, manually move the positive and negative samples if they are classified incorrectly. Run `python main.py --action train_region_classifier` to train a classifier. Trained models can be found in `data/models/region`. If `ZeroDivisionError: division by zero` happens, this is because there are too few training samples, so you should do the previous step again to label more particles. Observe the outputs on Terminal and identify the trained classifier with the highest VAL_ACC. If a new best validation accuracy is discovered during training, this will be printed to the terminal for you.

- Run `python main.py --action classify_regions --dir your_other_raw_image_folder --reg_path best_model_path` to crop out more particles. `your_other_raw_image_folder` is another directory containing raw images. `best_model_path` is the trained classifier with the highest VAL_ACC. In `data/classifier_training_samples`, manually move the positive and negative samples if they are classified incorrectly.

- Repeat the previous step until all raw images are cropped. You can also occationally do the second step again to train a new region classifier when the dataset grows larger and you want a better model.

- Make sure to train the region detector on all data you have before you proceed. Keep the best detector.

3. Train the code classifier as follows. 

- Run `python main.py --action train_code_classifier`. Trained models can be found in `data/models/code`. Choose the trained classifier with the highest VAL_ACC. If a new best validation accuracy is discovered during training, this will be printed to the terminal for you.


4. Get intensities as follows.

- Run `python main.py --action get_intensity --dir image_dir --reg_path best_region_detector_path`. 

- Check out the contours drawn on normalizd images in `data/hulls/`

- Check out the intensities in `data/intensities/`
