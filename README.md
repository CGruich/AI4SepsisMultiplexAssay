Files in this folder:

- all files used and generated by the algorithm are in `data` (at least for now)

  - `data/best_models` contains the best region detector and code classifier 

  - `data/raw` contains raw images

  - `data/classifier_training_samples` contains classified particles

  - `data/hulls` contains images with contours

- `notes` contains notes taken for me

- other files are code


How to name files:

- The directory name should start with the code name followed by `(`, e.g. `Selected images for DL/1-1/1-1 (1)`, `Selected images for DL/1-1/1-1 (2)`, etc.

- name each ref image in each directory: `1_ref.tiff`, `2_ref.tiff`, etc

- name each corresponding particle image: name the first image corresponding to `1_ref.tiff` as `1.tiff`, and subsequent ones `1_2.tiff`, `1_3.tiff`, etc.

How to run the codebase:

0. Activate virtual environment, `source venv/bin/activate`. Do this once when you open a new Terminal.

```
Just a side note: to make a new virtual environment

cd path/to/folder

python3.9 -m venv venv

source venv/bin/activate

pip3 install --upgrade pip

pip3 install -r requirements.txt
```


To use this codebase, run main.py. Depending on your task, do the following. 

~~Inside `main()`, do the following.~~ 

1. If you don't have MSER parameters, in terminal, do `python main.py --action find_mser_params`. 

~~run `find_mser_params()`.~~ 

2. Train the region detector as follows. 

- Choose a directory containing raw images as the training and validation dataset. Do `python main.py --action classify_regions --dir your_raw_image_folder`, and replace `your_raw_image_folder` with your directory. Cropped particles are in `data/classifier_training_samples`. 

<strike>
Run `classify_regions()` to crop out particles. Inside the function, set `load_path` to `None`, and `img_folder` to your directory.
</strike>

- In `data/classifier_training_samples`, manually move the positive and negative samples if they are classified incorrectly. Run `python main.py --action train_region_classifier` to train a classifier. Trained models can be found in `data/models/region`. If `ZeroDivisionError: division by zero` happens, this is because there are too few training samples, so you should do the previous step again to label more particles. Observe the outputs on Terminal and identify the trained classifier with the highest VAL_ACC. You can `cmd + F` for `NEW BEST ACCURACY` in the output.

- Run `python main.py --action classify_regions --dir your_other_raw_image_folder --reg_path best_model_path` to crop out more particles. `your_other_raw_image_folder` is another directory containing raw images. `best_model_path` is the trained classifier with the highest VAL_ACC. In `data/classifier_training_samples`, manually move the positive and negative samples if they are classified incorrectly.

~~`train_region_classifier()`~~ 
<strike>
Choose the trained classifier with the highest VAL_ACC and set `load_path` in `classify_regions()` to its path. Change `img_folder` to other directories containing raw images and run `classify_regions()` to crop out more particles. 
</strike>

- Repeat the previous step until all raw images are cropped. You can also occationally do the second step again to train a new region classifier when the dataset grows larger and you want a better model.

- Make sure to train the region detector on all data you have before you proceed. Keep the best detector.

3. Train the code classifier as follows. 

- Run `python main.py --action train_code_classifier`. Trained models can be found in `data/models/code`. Choose the trained classifier with the highest VAL_ACC. You can `cmd + F` for `NEW BEST ACCURACY` in the output.

~~`train_code_classifier()`~~. 

<strike>
Change the `model_load_path` of `region_detector` and `code_classifier` in `test_system()` to the best trained classifier paths.
</strike>


- Run `python main.py --action test_system --dir image_dir --reg_path best_region_detector_path --code_path best_code_classifier_path`. Check the output for the number of particles found for each code. Repeat this step until all raw images are processed.

<strike>
Change `img_folder()` in `test_system()` to a directory containing raw images as the test dataset. Run `test_system()`.
</strike>

4. Get intensities as follows.

- Run `python main.py --action get_intensity --dir image_dir --reg_path best_region_detector_path`. 

- Check out the contours drawn on normalizd images in `data/hulls/`

- Check out the intensities in `data/intensities/`


TODOs:

~~ - fix ref in test_system ~~
~~ - automate model selection. maybe do patience ~~
- pass model hyperparams as parameters
~~ - normalize ~~
- region detector val acc fluctuate
